name: "Generate BOM for a System Capture project with part data from an external DeHDL library repository"
description: >
  Generate a "complete BOM" for the project, fetching part data from an external DeHDL
  repository, and attach it as an artifact to the run.

  Works for System Capture projects.

inputs:
  bom_file:
    description: >
      An input BOM file generated by py-allspice
    required: true
  library_path:
    description: >
      Path (directory) to the root of a DeHDL / System Capture part library repository containing one or more *.ptf files. You can checkout a separate repo into a subdirectory and point here.
    required: true
  part_number_column_name:
    description: >
      Column header in the input BOM whose values will be matched against a column in the PTF files (see search_ptf_column_name).
    required: true
  part_type_column_name:
    description: >
      Column header in the input BOM whose values correspond to the PART type (the token after PART in the PTF file). Used to select which PTF file to search.
    required: true
  search_ptf_column_name:
    description: >
      Column header inside each PTF file to search for (e.g. AML, PART_NUMBER, VALUE). Must exactly match one of the parsed PTF title row entries.
    required: true
  include_ptf_columns:
    description: >
      Comma separated list of column names from the PTF file whose values you want to copy into the BOM for each matched part. Order must align with add_bom_columns.
    required: true
  add_bom_columns:
    description: >
      Comma separated list of column names to create (append) in the output BOM that will receive the corresponding values from include_ptf_columns.
    required: true
  output_path:
    description: "Path to the output file"
    required: true
    default: "complete_bom.csv"
runs:
  using: "docker"
  image: "Dockerfile"
  args:
    - "--library_path"
    - ${{ inputs.library_path }}
    - "--part_number_column_name"
    - ${{ inputs.part_number_column_name }}
    - "--part_type_column_name"
    - ${{ inputs.part_type_column_name }}
    - "--search_ptf_column_name"
    - ${{ inputs.search_ptf_column_name }}
    - "--include_ptf_columns"
    - ${{ inputs.include_ptf_columns }}
    - "--add_bom_columns"
    - ${{ inputs.add_bom_columns }}
    - "--output_path"
    - "${{ github.workspace}}/${{ inputs.output_path }}"
    - ${{ inputs.bom_file }}
